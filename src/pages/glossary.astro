---
// src/pages/glossary.astro
import Layout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { sort } from 'astro/components'; // Not strictly needed, but common

// 1. Fetch all terms and sort them
const allTerms = await getCollection('glossary');
const sortedTerms = allTerms.sort((a, b) => {
	if (a.data.weight !== b.data.weight) {
		return a.data.weight - b.data.weight;
	}
	return a.data.term.localeCompare(b.data.term);
});

// 2. Group terms by category
const groupedTerms = sortedTerms.reduce(
	(acc, term) => {
		const category = term.data.category;
		if (!acc[category]) {
			acc[category] = [];
		}
		acc[category].push(term);
		return acc;
	},
	{} as Record<string, typeof allTerms>
);

const sortedCategories = Object.keys(groupedTerms).sort();

const pageTitle = 'Demystifying Debt Terms: Financial Glossary';
---

<Layout title={pageTitle}>
	<div class="container mx-auto p-4 max-w-7xl">
		<header class="mb-10 border-b pb-4">
			<h1 class="text-4xl font-extrabold mb-2 text-indigo-700">
				{pageTitle}
			</h1>
			<p class="text-xl text-gray-600">
				Simple, direct explanations for commonly used and sometimes frightening
				financial jargon.
			</p>
		</header>

		<div
			class="bg-red-50 border-l-4 border-red-400 p-4 mb-10 text-sm text-red-800 font-semibold"
		>
			<p class="font-bold mb-1">THIS IS NOT FINANCIAL ADVICE</p>
			<p>
				The definitions provided here are for informational purposes only. If
				you are experiencing financial difficulty, you must seek free,
				regulated, and impartial advice from a qualified charity or official
				government service. Do not rely on this information alone to make
				decisions about your debt.
			</p>
		</div>

		{
			sortedCategories.map((category) => (
				<section class="mb-8">
					<h2 class="text-3xl font-bold mb-4 border-b pb-2 text-gray-800">
						{category}
					</h2>
					<div class="space-y-6">
						{groupedTerms[category].map(async (entry) => {
							// Mark map callback as async
							// 3. CORRECTLY RENDER THE MARKDOWN BODY
							// We await the render() function to get the object containing the Content component.
							const { Content } = await entry.render();

							return (
								<div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
									<h3 class="text-xl font-semibold text-gray-900 mb-1">
										{entry.data.term}
									</h3>
									{/* 4. Use the component directly inside the article tag */}
									<article class="prose max-w-none text-gray-700">
										<Content />
									</article>
								</div>
							);
						})}
					</div>
				</section>
			))
		}

		<footer class="mt-10 pt-6 border-t text-sm text-gray-500">
			<p>
				Last updated: {
					new Date().toLocaleDateString('en-GB', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
					})
				}
			</p>
		</footer>
	</div>
</Layout>
