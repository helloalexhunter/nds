---
// src/pages/help.astro
import Layout from '../layouts/BaseLayout.astro';
import CharityList from '../components/CharityList.jsx';
import charityData from '../data/astro_charity_data.json';

const REQUIRED_CATEGORIES = [
	'Debt Advice & Financial',
	'Food Banks & Relief',
	'Shelter & Housing',
	'Mental Health Support',
];

let combinedCharities = [];

for (const category of REQUIRED_CATEGORIES) {
	if (charityData[category] && Array.isArray(charityData[category])) {
		combinedCharities = combinedCharities.concat(charityData[category]);
	}
}

// Ensure the array only contains unique organisations
const uniqueCharitiesMap = combinedCharities.reduce((acc, charity) => {
	acc[charity.registered_charity_number] = charity;
	return acc;
}, {});

const finalCharityData = Object.values(uniqueCharitiesMap);
const finalCount = finalCharityData.length;

let warningMessage = null;
if (!charityData['']) {
	warningMessage = '';
}
---

<Layout title="Find Local Help & Support">
	<div class="container mx-auto p-4 max-w-7xl">
		<div
			class="bg-red-50 border-l-4 border-red-400 p-6 mb-8 text-red-800 rounded-lg shadow-sm"
		>
			<h2 class="font-bold text-xl mb-2">Important Data Accuracy Statement</h2>
			<p class="mb-3 max-w-none">
				The information provided here is collated from publicly available
				government registers and open data sources (including the Charity
				Commission).
			</p>
			<p class="mb-3 font-semibold max-w-none">
				We cannot guarantee the real-time accuracy, availability, or suitability
				of any organisation listed.
			</p>
			<p class="max-w-none">
				Before contacting any organisation, you must verify their current
				address, phone number, and services directly via their official website
				or register listing.
			</p>
		</div>

		{/* --- Header Copy Update --- */}
		<h1 class="text-4xl font-extrabold mb-4 text-gray-900">
			Find Urgent Local Support & Organisations
		</h1>

		<p class="mb-6 text-xl text-gray-600 max-w-none">
			Use the buttons below to immediately search over <span class="font-bold"
				>{finalCount.toLocaleString()}</span
			> registered <span class="font-semibold">organisations</span> offering help
			with debt, food, shelter, and more, all near your location.
		</p>

		{
			warningMessage && (
				<div
					class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6"
					role="alert"
				>
					<p class="font-bold max-w-none">Data Warning</p>
					<p class="max-w-none">{warningMessage}</p>
				</div>
			)
		}

		<CharityList initialData={finalCharityData} client:load />

		<p class="mt-10 text-sm text-gray-500 border-t pt-4 max-w-none">
			Data sourced from the Charity Commission register (public extract) and
			geocoded using Ordnance Survey Code-Point Open data for accurate distance
			calculation. Lists include registered charities, benevolent bodies, and
			trusts.
		</p>
	</div>
</Layout>
